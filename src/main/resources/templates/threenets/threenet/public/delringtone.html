<!DOCTYPE html>

<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>删除铃音</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../public/layui/css/layui.css">
    <link rel="stylesheet" href="../../public/css/commer.css">
    <link rel="stylesheet" type="text/css" href="../../public/dataTables/jquery.dataTables.min.css">
    <link rel="stylesheet" href="../../client/threenets/css/head.css">
</head>

<body>
    <div style="width:850px;margin:10px auto;">
        <div style="padding-top:10px;padding-left:0px;font-size:16px;">
            手机号：<input type="text" id="ringMsisdn" maxlength="11">
            <button type="button" class="btn btn-primary" id="sear" onclick="findRingInfoByMsisdn();">搜索</button>
            <button type="button" class="btn btn-primary" id="sear" onclick="resetRingMsisdnText();">清空</button>
        </div>
        <div class="layui-row per">
            <div class="layui-col-md4">
                <div class="grid-demo grid-demo-bg1 lt" style="float: left">个人铃音设置</div>
            </div>
            <div class="layui-col-md4 ">
                <div class="grid-demo rg" onclick="delRingSettingListByMsisdn">批量删除</div>
            </div>
        </div>
        <table class="layui-table" id="set" style="width:850px">
            <thead>
                <tr>
                    <th><input type="checkbox" id= "setCheck"></th>
                    <th>设置ID</th>
                    <th>铃音ID</th>
                    <th>铃音类型</th>
                    <th>时间段类型</th>
                    <th>轮播类型</th>
                    <th>开始时间</th>
                    <th>结束时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody class="ringSettingListByMsisdnTbody">
<!--                <tr>-->
<!--                    <td><input type="checkbox" name = "check"></td>-->
<!--                    <td>300</td>-->
<!--                    <td>500</td>-->
<!--                    <td>aaaaa</td>-->
<!--                    <td>iphone7p</td>-->
<!--                    <td>有</td>-->
<!--                    <td>2019-02-21 12:12:23</td>-->
<!--                    <td>2019-02-23 16:15:43</td>-->
<!--                    <td><i class="layui-icon layui-icon-delete" title="删除" onclick="Delete();"></i></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td><input type="checkbox" name = "check"></td>-->
<!--                    <td>300</td>-->
<!--                    <td>500</td>-->
<!--                    <td>aaaaa</td>-->
<!--                    <td>iphone7p</td>-->
<!--                    <td>有</td>-->
<!--                    <td>2019-02-21 12:12:23</td>-->
<!--                    <td>2019-02-23 16:15:43</td>-->
<!--                    <td><i class="layui-icon layui-icon-delete" title="删除" onclick="Delete();"></i></td>-->
<!--                </tr>-->
            </tbody>
        </table>
        <div class="layui-row per">
            <div class="layui-col-md4">
                <div class="grid-demo grid-demo-bg1 lt" style="float: left">个人铃音库列表</div>
            </div>
            <div class="layui-col-md4 layui-col-md-offset4">
                <div class="grid-demo rg"  onclick="delRingListByMsisdn()">批量删除</div>
            </div>
        </div>
        <table class="layui-table" id="per" style="width:850px">
            <thead>
                <tr>
                    <th><input type="checkbox" id= "perCheck"></th>
                    <th>铃音ID</th>
                    <th>铃音名称</th>
                    <th>铃音类别</th>
                    <th>有效期</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody class="ringListByMsisdnTbody">
<!--                <tr>-->
<!--                    <td><input type="checkbox" name = "percheck"></td>-->
<!--                    <td>300</td>-->
<!--                    <td>500</td>-->
<!--                    <td>aaaaa</td>-->
<!--                    <td>iphone7p</td>-->
<!--                    <td>有</td>-->
<!--                    <td>2019-02-21 12:12:23</td>-->
<!--                    <td>2019-02-23 16:15:43</td>-->
<!--                    <td><i class="layui-icon layui-icon-delete" title="删除" onclick="Delete();"></i></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <td><input type="checkbox" name = "percheck"></td>-->
<!--                    <td>300</td>-->
<!--                    <td>500</td>-->
<!--                    <td>aaaaa</td>-->
<!--                    <td>iphone7p</td>-->
<!--                    <td>有</td>-->
<!--                    <td>2019-02-21 12:12:23</td>-->
<!--                    <td>2019-02-23 16:15:43</td>-->
<!--                    <td><i class="layui-icon layui-icon-delete" title="删除" onclick="Delete();"></i></td>-->
<!--                </tr>-->
            </tbody>
        </table>
    </div>
</body>
<script src="../../public/js/jquery-2.1.4.min.js"></script>
<script src="../../public/layui/layui.js"></script>
<script type="text/javascript" src="../../public/dataTables/jquery.dataTables.min.js"></script>
<script type="text/javascript" th:src="@{/public/layui/layui.js}"></script>
<script type="text/javascript" th:src="@{/public/layui/lay/modules/layer.js}"></script>
<script type="text/javascript" th:src="@{/public/js/ajax.js}"></script>
<script>
    //搜索
    function findRingInfoByMsisdn() {
        var msisdn = $("#ringMsisdn").val();
        if(msisdn == null || msisdn ==""){
            layer.msg("请输入手机号",{icon: 0, time: 3000});
            return;
        }else if(msisdn.length < 11){
            layer.msg("请输入正确的移动手机号码！");
            return;
        }
        var url = "/threenets/findRingInfoByMsisdn/" + msisdn;
        AjaxPut(url, {
            msisdn:msisdn
            }, function (res) {
            if (res.code == 200 && res.data) {
                var data = res.data;
                // layer.msg('该手机号的铃音信息已查到！', {icon: 6, time: 3000});
                // $("#set").DataTable().ajax.reload(msisdn, true);
                if(data != null){
                    var ringSettingListByMsisdn = $.parseJSON(data.ringSettingListByMsisdn);
                    var ringListByMsisdn = $.parseJSON(data.ringListByMsisdn);
                    if(!ringSettingListByMsisdn.success && !ringListByMsisdn.success){
                        layer.msg(ringSettingListByMsisdn.msg,{icon: 5,time: 3000});
                        return;
                    }
                    var ringSettingListByMsisdnRow = ringSettingListByMsisdn.rows;
                    var ringListByMsisdnRow = ringListByMsisdn.rows;
                    if(ringSettingListByMsisdnRow.length == 0 && ringListByMsisdnRow.length == 0){
                        $(".ringSettingListByMsisdnTbody").html("");
                        $(".ringListByMsisdnTbody").html("");
                        layer.msg("没有该用户的数据",{icon: 2,time: 3000});
                        return;
                    }
                    //个人铃音设置列表
                    if(ringSettingListByMsisdn.success){
                        if(ringSettingListByMsisdnRow.length == 0){
                            layer.msg("个人铃音设置列表无数据",{icon: 2,time: 3000});
                        }
                        var str = "";
                        for(var i = 0; i < ringSettingListByMsisdnRow.length; i++){
                            str += "<tr>";
                            str += "<td><input type='checkbox' name='check' value='{\"toneID\":\""+ringSettingListByMsisdnRow[i].toneID+"\",\"type\":\""+ringSettingListByMsisdnRow[i].type+"\",\"settingID\":\""+ringSettingListByMsisdnRow[i].settingID+"\"}'></td>";
                            str += "<td>"+ringSettingListByMsisdnRow[i].settingID+"</td>";
                            str += "<td>"+ringSettingListByMsisdnRow[i].toneID+"</td>";
                            str += "<td>"+ringSettingListByMsisdnRow[i].type+"</td>";

                            if(ringSettingListByMsisdnRow[i].timeType == 1){
                                str += "<td>每天时间段</td>";
                            }else{
                                str += "<td>全天播放</td>";
                            }

                            if(ringSettingListByMsisdnRow[i].loopType == 0){
                                str += "<td>顺序</td>";
                            }else{
                                str += "<td>随机</td>";
                            }

                            if(ringSettingListByMsisdnRow[i].startTime != null){
                                str += "<td>"+ringSettingListByMsisdnRow[i].startTime+"</td>";
                            }else{
                                str += "<td>-</td>";
                            }

                            if(ringSettingListByMsisdnRow[i].endTime != null){
                                str += "<td>"+ringSettingListByMsisdnRow[i].endTime+"</td>";
                            }else{
                                str += "<td>-</td>";
                            }
                            // str += "<td><a style='color: #000;' data-msg='12' href='javascript:singleDeleteRingSetting(\""+ringSettingListByMsisdnRow[i].settingID+"\",\""+ringSettingListByMsisdnRow[i].toneID+"\",\""+ringSettingListByMsisdnRow[i].type+"\");'>&nbsp;删除</a></td>";
                            str += "<td><a class='layui-icon layui-icon-delete' title='删除' href='javascript:singleDeleteRingSetting(\""+ringSettingListByMsisdnRow[i].settingID+"\",\""+ringSettingListByMsisdnRow[i].toneID+"\",\""+ringSettingListByMsisdnRow[i].type+"\");'></a></td>";
                            str += "</tr>";
                        }
                        $(".ringSettingListByMsisdnTbody").html(str);
                    }else{
                        layer.msg("获取个人铃音设置列表失败",{icon: 2, time: 3000});
                    }
                    //个人铃音库列表
                    if(ringListByMsisdn.success){
                        if(ringListByMsisdn.length == 0){
                            layer.msg("个人铃音库列表无数据",{icon: 2, time: 3000});
                        }
                        var str = "";
                        for(var i = 0; i < ringListByMsisdnRow.length; i++){
                            str += "<tr>";
                            str += "<td><input type='checkbox' name='percheck' value='"+ringListByMsisdnRow[i].id+"|"+ringListByMsisdnRow[i].type+"'></td>";
                            // str += "<td><input type='checkbox' name='perCheck' value='{\"id\":\""+ringListByMsisdnRow[i].id+"\",\"type\":\""+ringListByMsisdnRow[i].type+"\"}'></td>";
                            str += "<td>"+ringListByMsisdnRow[i].id+"</td>";
                            str += "<td>"+ringListByMsisdnRow[i].name+"</td>";
                            str += "<td>"+ringListByMsisdnRow[i].type+"</td>";
                            str += "<td>"+ringListByMsisdnRow[i].toneValidDay+"</td>";
                            if(ringListByMsisdnRow[i].status == 1){
                                str += "<td>正常</td>";
                            }else if(ringListByMsisdnRow[i].status == 2){
                                str += "<td>隐藏</td>";
                            }else{
                                str += "<td>-</td>";
                            }
                            str += "<td><a class='layui-icon layui-icon-delete' title='删除' href='javascript:singleDeleteRing(\""+ringListByMsisdnRow[i].id+"\",\""+ringListByMsisdnRow[i].type+"\");'></a></td>";
                            str += "</tr>";
                        }
                        $(".ringListByMsisdnTbody").html(str);
                    }else{
                        layer.msg("获取个人铃音库列表失败",{icom: 2, time: 3000});
                    }
                }else{
                    layer.msg("获取失败",{icom: 2, time: 3000});
                }
            } else {
                layer.msg(res.msg, {icon: 5, time: 3000});
            }
        });
    }

    //删除某一行个人铃音设置
    function singleDeleteRingSetting(settingID,toneID,type){
        if(confirm("删除该铃音设置会将相同设置ID的铃音设置一起删掉，确认删除？")){
            var msisdn = $("#ringMsisdn").val();
            if(msisdn == null || msisdn ==""){
                layer.msg("请输入手机号",{icon: 0, time: 3000});
                return;
            }
            var url = "/threenets/singleDeleteRingSet/"+msisdn;
            AjaxPut(url,{
                msisdn : msisdn,
                settingID : settingID,
                toneID : toneID,
                type : type
            },function (res) {
                if (res.code == 200 && res.data) {
                    findRingInfoByMsisdn(msisdn);
                    $("#set").DataTable().ajax.reload(msisdn, true);
                }else{
                    layer.msg(res.msg, {icon: 5, time: 3000});
                }
            });
            // formDialog("正在删除...");
            // $.post(url, {
            //     "msisdn" : msisdn,
            //     "settingID" : settingID,
            //     "toneID" : toneID,
            //     "type" : type
            // }, function(data, textstatus) {
            //     art.dialog({
            //         id : 'formDialog'
            //     }).close();
            //     if(data){
            //         deleteRingSeting();
            //     }else{
            //         tipDialog("删除失败！");
            //     }
            // }, "json");
        }
    }
    //删除某一行个人铃音库
    function singleDeleteRing(toneIds,type){
        if(confirm("确认删除该铃音？")){
            var msisdn = $("#ringMsisdn").val();
            if(msisdn == null || msisdn ==""){
                layer.msg("请输入手机号",{icon: 0, time: 3000});
                return;
            }
            var url = "/threenets/singleDeleteRing/"+msisdn;
            AjaxPut(url,{
                msisdn:msisdn,
                toneIds : toneIds,
                type : type
            }, function (res) {
                if (res.code == 200 && res.data) {
                    findRingInfoByMsisdn(msisdn);
                    $("#set").DataTable().ajax.reload(msisdn, true);
                }else{
                    layer.msg(res.msg, {icon: 5, time: 3000});
                }
            });
        }
    }
    //批量删除个人铃音设置
    function delRingSettingListByMsisdn(){
        if(confirm("删除选中的铃音设置会将相同设置ID的铃音设置一起删掉，确认删除？")){
            var msisdn = $("#ringMsisdn").val();
            if(msisdn == null || msisdn ==""){
                layer.msg("请输入手机号",{icon: 0, time: 3000});
                return;
            }
            var valArr = new Array;
            $(".ringSettingListByMsisdnTbody :checkbox[checked]").each(function(i){
                valArr[i] = $(this).val();
            });
            var vals = valArr.join(',');
            if(vals == null || vals.length == 0){
                layer.msg("请选择需要删除的铃音设置",{icon: 0, time: 3000});
                return;
            }
            var url = "/threenets/batchDeleteRingSet";
            AjaxPut(url,{
                msisdn:msisdn,
                vals:vals
            },function (res) {
                if (res.code == 200 && res.data) {
                    findRingInfoByMsisdn(msisdn);
                    $("#set").DataTable().ajax.reload(msisdn, true);
                }else{
                    layer.msg(res.msg, {icon: 5, time: 3000});
                }
            });
            // $.post(url, {
            //     "msisdn" : msisdn,
            //     "vals" : vals
            // }, function(data, textstatus) {
            //     art.dialog({
            //         id : 'formDialog'
            //     }).close();
            //     if(data){
            //         deleteRingSeting();
            //     }else{
            //         tipDialog("删除失败！");
            //     }
            // }, "json");
        }
    }
    //批量删除个人铃音库列表
    function delRingListByMsisdn(){
        if(confirm("确认删除选中的铃音?")){
            var msisdn = $("#ringMsisdn").val();
            if(msisdn == null || msisdn ==""){
                layer.msg("请输入手机号",{icon: 0, time: 3000});
                return;
            }
            var valArr = new Array;
            $(".ringListByMsisdnTbody :checkbox[checked]").each(function(i){
                valArr[i] = $(this).val();
            });
            var vals = valArr.join(',');
            if(vals == null || vals.length == 0){
                layer.msg("请选择需要删除的铃音库",{icon: 0, time: 3000});
                return;
            }
            var url = "/threenets/batchDeleteRing";
            AjaxPut(url,{
                msisdn:msisdn,
                vals:vals
            },function (res) {
                if (res.code == 200 && res.data) {
                    findRingInfoByMsisdn(msisdn);
                    $("#set").DataTable().ajax.reload(msisdn, true);
                }else{
                    layer.msg(res.msg, {icon: 5, time: 3000});
                }
            });
            //
            // $.post(url, {
            //     "msisdn" : msisdn,
            //     "vals" : vals
            // }, function(data, textstatus) {
            //     art.dialog({
            //         id : 'formDialog'
            //     }).close();
            //     if(data){
            //         deleteRingSeting();
            //     }else{
            //         tipDialog("删除失败！");
            //     }
            // }, "json");
        }
    }

    //个人铃音设置列表
    $("#setCheck").click(function(){
        $("input[name='check']").prop("checked",this.checked);
    })
    $("input[name='check']").change(function(){
        if($("input[name='check']").not("input:checked").size() <= 0){
            $("#setCheck").prop("checked",true);
        }else{
            $("#setCheck").prop("checked",false);
        }
    })
    //个人铃音库列表
    $("#perCheck").click(function(){
        $("input[name='percheck']").prop("checked",this.checked);
    })
    $("input[name='percheck']").change(function(){
        if($("input[name='percheck']").not("input:checked").size() <= 0){
            $("#perCheck").prop("checked",true);
        }else{
            $("#perCheck").prop("checked",false);
        }
    })

    function resetRingMsisdnText() {
        $("#ringMsisdn").val("");
    }
</script>

</html>
