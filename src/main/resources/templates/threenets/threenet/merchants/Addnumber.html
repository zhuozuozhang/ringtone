<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <base href=".">
    <title>添加商户</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" th:href="@{/public/layui/css/layui.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/public/layui/css/modules/layer/default/layer.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/client/threenets/css/ThunderBase2.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/client/threenets/css/common.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/client/threenets/css/Addmerchants.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/client/threenets/css/enterpriseBell.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/client/threenets/css/MyPlus.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/client/threenets/css/Add.css}">
    <script type="text/javascript" th:src="@{/public/js/jquery-2.1.4.min.js}"></script>
    <script type="text/javascript" th:src="@{/public/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/public/layui/lay/modules/layer.js}"></script>
    <script type="text/javascript" th:src="@{/public/js/numASMD.js}"></script>
    <script type="text/javascript" th:src="@{/public/js/ajax.js}"></script>
    <style>
        .layui-input-block {
            text-align: right;
        }

        .addBell {
            margin-top: 0;
            padding: 0;
        }

        .layui-form-select .layui-input {
            padding-right: 30px;
            cursor: pointer;
            height: 25px;
            margin-top: 7px;
        }

        .disable {
            pointer-events: none;
        }
    </style>
</head>

<body>
    <form action="/threenets/insterThreeNetsChildOrder" name="Form" id="Form" method="post" class="layui-form">
        <div id="newBlocPage" style="padding-bottom: 20px;">
            <div class="newBlocPage-con4 clear">
                <div class="right-newBlocPage-con4">
                    <div style="font-size: 12px; color: #333;line-height: 20px;text-align: left;">
                        温馨提示：</br>
                        1.若要添加多个号码，号码之间使用“换行符（回车）”分隔，单次最多支持20个用户。</br>
                        2.当输入框号码后面出现"#错误消息"，比如"#号码不正确"时，代表该行的号码格式错误，需要修改。修改完成后请注意去掉"#错误消息"的标识。
                    </div>
                </div>
                <textarea onchange="mykeyup()" name="memberTels" id="member_phone" required lay-verify="required"></textarea>
                <h6><i style="color: red">*</i>成员号码</h6>
                <div style="display: block;" class="footer-newBlocPage-con4 clear" id="rs"></div>
                <div class="radio-newBlocPage-con4" id="fee" style="display:none">
                    <div class="layui-form-item" style="position: relative;">
                        <label class="layui-form-label" style="width:120px;">
                            <i style="color: red">*</i>移动资费:
                        </label>
                        <div class="layui-input-block" style='width: 150px;margin-left: 150px;'>
                            <input checked="" type="radio" name="miguPrice" id="PayPrice" value="5" title="5元/月">
                        </div>
                        <span style="position: absolute;top: 11px;right: 90px;text-decoration: none;color: black;">申请高资费：</span>
                        <div class="layui-input-block" style="width: 80px;position: absolute;top: 0;right: 0;">
                            <select name="specialPrice" id="specialPrice" lay-filter="specialPrice">
                                <option value="">无</option>
                                <option value="8">8元</option>
                                <option value="10">10元</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="radio-newBlocPage-con4" id="fee1" style="display:none">
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width:120px;color: #17a9ff;" onclick="dxcx('floatingWindows')">
                            <i style="color: red">*</i>电信资费
                        </label>
                    </div>
                </div>
                <div class="radio-newBlocPage-con4" id="fee2" style="display:none">
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width:120px;">
                            <i style="color: red">*</i>是否免短:
                        </label>
                        <div class="layui-input-block">
                            <input type="radio" name="mianduan" value="否" title="否" checked="" lay-filter="mdRadio">
                            <input type="radio" name="mianduan" value="是" title="是" lay-filter="mdRadio">
                        </div>
                    </div>
                </div>
                <div class="radio-newBlocPage-con4" id="fee3" style="display:none">
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width:120px;">
                            <i style="color: red">*</i>联通资费:
                        </label>
                        <div class="layui-input-block">
                            <input type="radio" name="swxlPrice" value="5" title="5元/月" lay-filter="unicomRadio">
                            <input type="radio" name="swxlPrice" value="10" title="10元/月" checked=""  lay-filter="unicomRadio">
                            <input type="radio" name="swxlPrice" value="20" title="20元/月" lay-filter="unicomRadio">
                        </div>
                    </div>
                </div>

            </div>
            <!-- 电信 -->
            <div id="qyzzdiv" style="display:none">
                <div class="newBlocPage-con5 clear">
                    <div class="file_css2">
                        <div class="show_input_file" id="showqyzz5"></div>
                        <div class="file_css_button qiye" style="color: #13b5b1;">点击上传营业执照</div>
                        <input type="file" class="input_file" id="qyzz5" name="companyFile" required>
                        <input type="hidden" id="companyUrl" name="companyUrl" value="">
                    </div>
                    <h6><i style="color: red">*</i>上传营业执照</h6>
                </div>
                <div class="newBlocPage-con6 clear">
                    <div class="file_css2">
                        <div class="show_input_file" id="showqyzx5"></div>
                        <div class="file_css_button que" style="color: #13b5b1;">点击上传知晓函</div>
                        <input type="file" class="input_file" id="qyzx5" name="clientFile" required>
                        <input type="hidden" name="clientUrl" id="clientUrl" value="">
                    </div>
                    <h6><i style="color: red">*</i>上传知晓函</h6>
                    <div class="footer-newBlocPage-con6 clear">
                        <a href="http://xnh.xnhkfpt.com/uploadFiles/file/cringopenbusiness.docx"
                           style="font-size: 12px; color:#17a9ff;">知晓函模板下载</a>，填完后盖章扫描上传。<span style="color:red;"></span>
                    </div>
                </div>
            </div>
            <!-- 是否免短 -->
            <div id="sfmd" style="display:none;">
                <div class="newBlocPage-con6 clear">
                    <div class="file_css2">
                        <div class="show_input_file" id="showmdxy"></div>
                        <div class="file_css_button mds"style="color: #13b5b1;">点击上传免短协议</div>
                        <input type="file" class="input_file" id="mdxy" name="protocolFile" required multiple="multiple" accept="image/*">
                        <input type="hidden" name="protocolUrl" id="protocolUrl" value="">
                    </div>
                    <h6><i style="color: red">*</i>上传免短协议</h6>
                    <div class="footer-newBlocPage-con6 clear" style="text-align: right;">
                        <a th:href="@{/public/file/联通免短协议.docx}" style="font-size: 12px; color:#17a9ff;">免短协议下载</a>
                    </div>
                </div>
            </div>
            <input type="hidden" id="parentOrderId" name="parentOrderId" th:value="${orderId}">
            <input type="hidden" id="folderName" name="folderName" th:value="${folderName}">
            <input type="hidden" id="dxCount" value="0">
            <input type="hidden" id="ltCount" value="0">
            <div id="tijiao" class="newBlocPage-button" lay-submit lay-filter="formDemo">确定提交</div>
        </div>
    </form>
    <!--电信资费弹窗-->
    <div id="floatingWindows" style="height: 1743px;">
        <div class="floatingWindows parents" style="display: block">
            <div class="fw-DianXin parents" style="display: block;top: 15px !important;">
                <div class="close" onclick="CloseDxcx('floatingWindows');"><img
                        src="../../client/threenets/images/floating_ico_1.png"></div>
                <div class="dianxin1">电信资费说明</div>
                <div class="dianxin2 clear">
                    <div>北京,天津,河北,山西,辽宁,吉林,黑龙江,上海,江苏,浙江,福建,湖南,广东,广西,重庆,四川,陕西,青海,宁夏,西藏,海南,安徽</div>
                    <div>
                        <p>10元</p>
                        <p>三网平台电信资费</p>
                    </div>
                </div>
                <div class="dianxin2 clear">
                    <div>湖北,山东,江西,贵州,内蒙古,新疆,甘肃,云南</div>
                    <div>
                        <p>20元</p>
                        <p>三网平台电信资费</p>
                    </div>
                </div>
                <div class="dianxin3">
                    新疆,广东,浙江,湖南,江西三网平台暂未开通这些地区，如有需要开通请联系客服处理
                </div>
            </div>
        </div>
    </div>
    <script>
        //设置弹窗
        var floatingWindows = document.getElementById('floatingWindows');
        floatingWindows.style.height = '1000px';
        //初始化
        $(document).ready(function () {
            $("#tijiao").removeClass("disable");
            $("#sfmd").hide();
        });
        //成员号码验证
        function mykeyup() {
            var member_phone = $("#member_phone").val();
            var phones = member_phone.split(/[\r\n]/g);
            var myreg =  /^1\d{10}$/;
            var areg = /^0\d{2,3}-?\d{7,8}$/;
            for (i = 0; i < phones.length; i++) {
                if (!myreg.test(phones[i])) {
                    if (!areg.test(phones[i])) {
                        layer.msg('号码"' + phones[i] + '"不正确!');
                        break;
                    }
                }
            }
            matchingOperate(member_phone);
        }

        //验证手机号
        function matchingOperate(phones) {
            var parentOrderId = $("#parentOrderId").val();
            AjaxPost('/threenets/getOperate', {"phone": phones,"parentOrderId":parentOrderId}, function (result) {
                if (result.code == 200) {
                    //移动
                    if (result.data.mobile > 0 && result.data.mobileStatus) {
                        $("#fee").show();
                    }
                    //电信
                    if (result.data.telecom > 0 && result.data.telecomStatus) {
                        $("#dxCount").val(1);
                        $("#fee1,#qyzzdiv").show();
                    }
                    //联通
                    if (result.data.unicom > 0 && result.data.unicomStatus) {
                        $("#ltCount").val(1);
                        $("#fee2,#fee3").show();
                    }
                } else {
                    layer.msg(result.msg);
                }
            })
        }
        //打开弹窗
        function dxcx(tag, otag) {
            $("#" + tag).show();
        }
        //关闭弹窗
        function CloseDxcx(tag) {
            $("#" + tag).hide();
        }
        //上传企业资质
        $("form").on("change", "#qyzz5", function (e) {
            $(".qiye").html(this.value);
            uploadFile("companyFile")
        })
        //上传客户确认函
        $("form").on("change", "#qyzx5", function (e) {
            $(".que").html(this.value);
            uploadFile("clientFile")
        })
        //上传主体证明
        $("form").on("change", "#IDCARDURLfile", function (e) {
            $(".zhu").html(this.value);
            uploadFile("mainFile")
        })
        //免短协议
        $("form").on("change", "#mdxy", function (e) {
            $(".mds").html(this.value);
            uploadFile("protocolFile")
        })
        //申请高资费
        //表单提交
        layui.use('form', function () {
            var form = layui.form;
            form.on('radio(unicomRadio)', function(data){
                var val = data.value
                if(val == 5){
                    let mdValue = $('input[name="mianduan"]:checked ').val();
                    if (mdValue === "否"){
                        $('[name=swxlPrice]').each(function(i,item){
                            if($(item).val()==10){
                                $(item).prop('checked',true);
                                form.render();
                            }
                        });
                        layer.msg("5元资费只有免短业务可以使用!");
                    }
                }
            });
            form.on('radio(mdRadio)', function(data){
                var val = data.value
                if(val === "是"){
                    $("#sfmd").show();
                }else{
                    $("#sfmd").hide();
                    $('[name=swxlPrice]').each(function(i,item){
                        if($(item).val()==10){
                            $(item).prop('checked',true);
                            form.render();
                        }
                    });
                }
            });
            //申请高资费
            form.on('select(specialPrice)', function (data) {
                if (data.value == 8 || data.value == 10) {
                    $("#PayPrice").prop('checked', false);
                    form.render();
                } else if (data.value == "无") {
                    $("#PayPrice").prop('checked', true);
                    form.render();
                }
            });
            //监听提交
            form.on('submit(formDemo)', function (data) {
                $("#tijiao").addClass("disable");

                var member_phone = $("#member_phone").val();
                var phones = member_phone.split(/[\r\n]/g);
                var flag = false;
                $.ajax({
                    url: '/threenets/checkPhone?phones='+phones,
                    async:false,
                    type: 'get',
                    success: function (res) {
                        console.log(res);
                        if(res != 'success'){
                            layer.msg(res);
                            flag = true;
                        }
                    }
                })
                if(flag){
                    return;
                }

                //存在电信用户时需要验证电信的文件
                if ($("#dxCount").val() > 0 && $("#companyUrl").val() == "") {
                    layer.msg("电信用户需要上传企业资质!");
                    return;
                }
                if ($("#dxCount").val() > 0 && $("#clientUrl").val() == "") {
                    layer.msg("电信用户需要上传客户确认函!");
                    return;
                }
                //联通开通免短需要设置免短协议
                if ($("input[name='mianduan']:checked").val() == "是" && $("#protocolUrl").val() == "") {
                    layer.msg("开通免短需要上传免短协议!");
                    return;
                }
                AjaxPost("/threenets/insterThreeNetsChildOrder",$('#Form').serialize(),function (result) {
                    if (result.code == "200") {
                        let index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                        parent.layer.close(index);
                        window.parent.location.reload();//刷新父页面
                    } else {
                        $("#tijiao").removeClass("disable");
                        layer.msg(data.msg, {icon: 3, time: 1000});
                    }
                })
            });
        });

        //上传文件
        function uploadFile(url) {
            var layuiLoding = layer.load(0, { //icon支持传入0-2
                time:false,
                shade: [0.5, '#9c9c9c'], //0.5透明度的灰色背景
                content: '文件上传中...',
                success: function (layero) {
                    layero.find('.layui-layer-content').css({
                        'padding': '39px 10px',
                        'width': '100px'
                    });
                }
            });
            $.ajax({
                url: '/system/upload/' + url,
                type: 'POST',
                cache: false,
                data: new FormData($('#Form')[0]),
                processData: false,
                contentType: false
            }).done(function (res) {
                layer.close(layuiLoding);
                layer.msg(res.msg, {icon: 1, time: 1000});
                if (url === "companyFile") {
                    $("#companyUrl").val(res.data)
                } else if (url === "clientFile") {
                    $("#clientUrl").val(res.data)
                } else if (url === "mainFile") {
                    $("#mainUrl").val(res.data)
                } else if (url === "protocolFile") {
                    $("#protocolUrl").val(res.data)
                }
            }).fail(function (res) {
                layer.msg(res.msg, {icon: 2, time: 1000});
            });
        }
    </script>
</body>

</html>
